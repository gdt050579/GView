name: "Deploy release"

permissions:
  id-token: write
  attestations: write
  contents: write
  actions: write

on:
  push:
    branches:
      - release

  workflow_dispatch:
    inputs:
      isPreRelease:
        description: "Is this a pre-release?"
        required: true
        default: true
        type: boolean

env:
  BUILD_TYPE: Release

jobs:
  # --------------------------------------------------
  # Build all platforms (matrix)
  # --------------------------------------------------
  build-all:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-15-intel, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Use the composite action (inputs are strings)
      - name: Build & package
        uses: ./.github/actions/build
        with:
          build_type: ${{ env.BUILD_TYPE }}
          enable_tests: "false"
          use_vcpkg_cache: "true"
          upload_artifact: "true"
          artifact_path: "bin/Release/**"
          jobs_count: "0"

  # --------------------------------------------------
  # Publish to GitHub Release
  # --------------------------------------------------
  publish_job:
    name: "Publish to GitHub Release"
    runs-on: ubuntu-latest
    needs: [build-all]

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        run: |
          ver=$(python .github/workflows/get_version.py GViewCore/include/GView.hpp)
          echo "GVIEW_VERSION=$ver" >> "$GITHUB_ENV"

      # ------------------------
      # Download all artifacts from the matrix
      # ------------------------
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          # The composite action names artifacts as:
          #   build-Linux-Release, build-macOS-Release, build-Windows-Release
          pattern: build-*-Release
          merge-multiple: true
          path: artifacts

      # ------------------------
      # Publish Release
      # ------------------------
      - name: Publish GitHub release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "${{ env.GVIEW_VERSION }}"
          # On workflow_dispatch use the provided input; on push default to false
          prerelease: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.isPreRelease || false }}
          title: "GView Build ${{ env.GVIEW_VERSION }}"
          files: |
            artifacts/*.zip
