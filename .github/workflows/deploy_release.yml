name: "Deploy release"

permissions:
  id-token: write
  attestations: write
  contents: write
  actions: write

on:
  push:
    branches:
      - release

  workflow_dispatch:
    inputs:
      isPreRelease:
        description: "Is this a pre-release?"
        required: true
        default: true
        type: boolean

env:
  BUILD_TYPE: Release

jobs:
# --------------------------------------------------
# Reusable build job (multi-OS matrix inside)
# --------------------------------------------------
  build-all:
    name: "Build all platforms"
    uses: ./.github/workflows/build_reusable.yml
    with:
      build_type: Release
      enable_tests: false
      use_vcpkg_cache: true
      upload_artifact: true

      # Matches your reusable input exactly
      os_matrix: '["ubuntu-24.04","macos-15-intel","windows-latest"]'

      # Adjust if needed
      artifact_path: "bin/Release/**"
      jobs_count: 0

# --------------------------------------------------
# Publish to GitHub Release
# --------------------------------------------------
  publish_job:
    name: "Publish to GitHub Release"
    runs-on: ubuntu-latest
    needs: [build-all]

    steps:
    - uses: actions/checkout@v4

    - name: Extract version
      run: |
        ver=$(python .github/workflows/get_version.py GViewCore/include/GView.hpp)
        echo "GVIEW_VERSION=$ver" >> $GITHUB_ENV

    # ------------------------
    # Download artifacts
    # ------------------------

    - name: Download Ubuntu artifact
      uses: actions/download-artifact@v4
      with:
        name: build-ubuntu-24.04-Release
        path: artifacts

    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: build-macos-15-intel-Release
        path: artifacts

    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: build-windows-latest-Release
        path: artifacts

    # ------------------------
    # Publish Release
    # ------------------------

    - name: Publish GitHub release
      uses: marvinpinto/action-automatic-releases@latest
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: "${{ env.GVIEW_VERSION }}"
        prerelease: ${{ github.event.inputs.isPreRelease }}
        title: "GView Build ${{ env.GVIEW_VERSION }}"
        files: |
          artifacts/*.zip
