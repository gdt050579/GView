name: "Reusable Build"

on:
  workflow_call:
    inputs:
      build_type:
        description: "CMake build type"
        required: false
        type: string
        default: "Release"

      enable_tests:
        description: "Run tests?"
        required: false
        type: boolean
        default: false

      use_vcpkg_cache:
        description: "Cache vcpkg artifacts?"
        required: false
        type: boolean
        default: true

      os_matrix:
        description: "JSON array of runners (e.g. [\"ubuntu-24.04\",\"macos-15-intel\",\"windows-latest\"])"
        required: false
        type: string
        default: '["ubuntu-24.04","macos-15-intel","windows-latest"]'

      upload_artifact:
        description: "Upload build artifact?"
        required: false
        type: boolean
        default: false

      artifact_path:
        description: "Path (glob) to upload when upload_artifact=true"
        required: false
        type: string
        default: "bin/Release/**"

      jobs_count:
        description: "Number of parallel jobs for build (0 = auto)"
        required: false
        type: number
        default: 0

permissions:
  contents: read

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(inputs.os_matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # --------------------------
      # Compute JOBS count
      # --------------------------

      - name: Set JOBS (Linux/macOS)
        if: ${{ !startsWith(matrix.os, 'windows') }}
        shell: bash
        run: |
          if [ ${{ inputs.jobs_count }} -eq 0 ]; then
            echo "JOBS=$(nproc 2>/dev/null || sysctl -n hw.ncpu)" >> $GITHUB_ENV
          else
            echo "JOBS=${{ inputs.jobs_count }}" >> $GITHUB_ENV
          fi

      - name: Set JOBS (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          if (${{ inputs.jobs_count }} -eq 0) {
            "JOBS=$env:NUMBER_OF_PROCESSORS" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding ASCII
          } else {
            "JOBS=${{ inputs.jobs_count }}" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding ASCII
          }

      # --------------------------
      # Cache vcpkg
      # --------------------------

      - name: Cache vcpkg
        if: ${{ inputs.use_vcpkg_cache }}
        uses: actions/cache@v4
        with:
          path: |
            build/vcpkg_installed
            build/vcpkg_downloads
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      # --------------------------
      # OS dependencies
      # --------------------------

      - name: Install dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            gcc-multilib \
            g++-multilib \
            build-essential \
            ninja-build \
            libsdl2-dev \
            libsdl2-ttf-dev \
            libltdl-dev

      - name: Install dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install autoconf autoconf-archive automake libtool make cmake ninja
          echo "VCPKG_CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV

      # --------------------------
      # Configure
      # --------------------------

      - name: Configure CMake (Linux/macOS)
        if: ${{ !startsWith(matrix.os, 'windows') }}
        shell: bash
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DENABLE_TESTS=${{ inputs.enable_tests && 'ON' || 'OFF' }}

      - name: Configure CMake (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $enableTests = if (${{ inputs.enable_tests }}) { "ON" } else { "OFF" }

          & cmake `
            -S "." `
            -B "build" `
            -DCMAKE_BUILD_TYPE="${{ inputs.build_type }}" `
            -DENABLE_TESTS="$enableTests"

      # --------------------------
      # Build
      # --------------------------

      - name: Build (Linux/macOS)
        if: ${{ !startsWith(matrix.os, 'windows') }}
        shell: bash
        run: |
          cmake --build build \
            --config ${{ inputs.build_type }} \
            --parallel $JOBS

      - name: Build (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          & cmake --build build `
            --config "${{ inputs.build_type }}" `
            --parallel $env:JOBS

      # --------------------------
      # Tests
      # --------------------------

      - name: Run tests (Linux/macOS)
        if: ${{ inputs.enable_tests && !startsWith(matrix.os, 'windows') }}
        shell: bash
        run: |
          ctest --test-dir build --output-on-failure

      - name: Run tests (Windows)
        if: ${{ inputs.enable_tests && startsWith(matrix.os, 'windows') }}
        shell: pwsh
        run: |
          ctest --test-dir build --output-on-failure

      # --------------------------
      # Artifact packaging
      # --------------------------

      - name: Package artifact (Linux/macOS)
        if: ${{ inputs.upload_artifact && !startsWith(matrix.os, 'windows') }}
        shell: bash
        run: |
          zip_name="build-${{ matrix.os }}-${{ inputs.build_type }}.zip"

          cd "$GITHUB_WORKSPACE"
          zip -9 -r "$zip_name" ${{ inputs.artifact_path }}

          echo "AZIP=$GITHUB_WORKSPACE/$zip_name" >> $GITHUB_ENV

      - name: Package artifact (Windows)
        if: ${{ inputs.upload_artifact && startsWith(matrix.os, 'windows') }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $zipName = "build-${{ matrix.os }}-${{ inputs.build_type }}.zip"
          $files = Get-ChildItem -Path $Env:GITHUB_WORKSPACE -Recurse -Include ${{ inputs.artifact_path }} -File

          if (!$files) {
            Write-Host "No files matched: ${{ inputs.artifact_path }}"
            exit 0
          }

          $dest = Join-Path $Env:GITHUB_WORKSPACE $zipName
          if (Test-Path $dest) { Remove-Item $dest }

          Compress-Archive -Path ($files.FullName) -DestinationPath $dest -Force
          "AZIP=$dest" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding ASCII

      # --------------------------
      # Upload
      # --------------------------

      - name: Upload artifact
        if: ${{ inputs.upload_artifact }}
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ inputs.build_type }}
          path: ${{ env.AZIP }}
          retention-days: 1
